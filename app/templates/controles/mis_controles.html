{% extends "base.html" %}

{% block title %}Mis Controles - SST Colombia{% endblock %}

{% block content %}
<div style="padding: 30px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <div>
            <h1 style="margin: 0 0 10px 0; color: #333; font-size: 28px;">
                üë§ Mis Controles
            </h1>
            <p style="margin: 0; color: #666; font-size: 13px;">
                Controles asignados a tu responsabilidad
            </p>
        </div>
        <a href="{{ url_for('controles.listar_controles') }}" 
           style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
            üìã Ver Todos
        </a>
    </div>

    <!-- Estad√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
            <div style="font-size: 12px; color: #0056b3; margin-bottom: 10px; font-weight: bold;">TOTAL ASIGNADOS</div>
            <div style="font-size: 36px; font-weight: bold; color: #007bff;">{{ controles_asignados|length }}</div>
        </div>
        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <div style="font-size: 12px; color: #856404; margin-bottom: 10px; font-weight: bold;">EN PROCESO</div>
            <div style="font-size: 36px; font-weight: bold; color: #ffc107;">{{ por_estado.get('En Proceso', [])|length }}</div>
        </div>
        <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="font-size: 12px; color: #155724; margin-bottom: 10px; font-weight: bold;">COMPLETADOS</div>
            <div style="font-size: 36px; font-weight: bold; color: #28a745;">
                {{ (por_estado.get('Verificado', [])|length) + (por_estado.get('Efectivo', [])|length) }}
            </div>
        </div>
        <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
            <div style="font-size: 12px; color: #721c24; margin-bottom: 10px; font-weight: bold;">REQUIEREN AJUSTE</div>
            <div style="font-size: 36px; font-weight: bold; color: #dc3545;">{{ por_estado.get('Requiere Ajuste', [])|length }}</div>
        </div>
    </div>

    <!-- Controles por Estado -->
    {% if controles_asignados %}
        {% for estado, controles in por_estado.items() %}
            {% if controles %}
                <div style="background: white; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 30px; overflow: hidden;">
                    <!-- Header -->
                    <div style="background: #f8f9fa; padding: 15px 20px; border-bottom: 2px solid #ddd;">
                        {% set estado_color = {
                            'Planificado': '#6c757d',
                            'Asignado': '#17a2b8',
                            'En Proceso': '#ffc107',
                            'Implementado': '#007bff',
                            'Verificado': '#28a745',
                            'Efectivo': '#28a745',
                            'Inefectivo': '#dc3545',
                            'Requiere Ajuste': '#ffc107',
                            'Cerrado': '#212529'
                        } %}
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span style="background: {{ estado_color.get(estado, '#6c757d') }}; color: white; padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: bold;">
                                {{ estado }}
                            </span>
                            <span style="background: #e9ecef; color: #666; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                {{ controles|length }} item(s)
                            </span>
                        </h3>
                    </div>

                    <!-- Tabla -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">C√≥digo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">Riesgo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">Tipo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">Fecha</th>
                                    <th style="padding: 12px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6; font-size: 13px;">Efectividad</th>
                                    <th style="padding: 12px; text-align: center; font-weight: bold; color: #333; font-size: 13px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for control in controles %}
                                    <tr style="border-bottom: 1px solid #dee2e6; transition: background 0.2s;">
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            <span style="background: #e7f3ff; color: #0056b3; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px;">
                                                {{ control.codigo }}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            <strong style="font-size: 13px;">{{ control.nombre }}</strong>
                                        </td>
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            <small style="color: #666;">
                                                {{ control.riesgo.nombre_riesgo if control.riesgo else '-' }}
                                            </small>
                                        </td>
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            {% set tipo_color = {
                                                'Preventivo': '#28a745',
                                                'Correctivo': '#ffc107',
                                                'Detectivo': '#17a2b8',
                                                'Mitigante': '#6c757d'
                                            } %}
                                            <span style="background: {{ tipo_color.get(control.tipo_control, '#6c757d') }}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                                {{ control.tipo_control }}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            <small style="color: #666;">
                                                {{ control.fecha_planeada.strftime('%d/%m/%Y') if control.fecha_planeada else '-' }}
                                            </small>
                                        </td>
                                        <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                                            {% if control.efectividad_porcentaje %}
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <div style="width: 50px; height: 18px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                                        {% set color = '#28a745' if control.efectividad_porcentaje >= 80 else '#ffc107' if control.efectividad_porcentaje >= 50 else '#dc3545' %}
                                                        <div style="width: {{ control.efectividad_porcentaje }}%; height: 100%; background: {{ color }};"></div>
                                                    </div>
                                                    <strong style="font-size: 12px;">{{ control.efectividad_porcentaje }}%</strong>
                                                </div>
                                            {% else %}
                                                <span style="color: #999;">-</span>
                                            {% endif %}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <div style="display: flex; gap: 5px; justify-content: center;">
                                                <a href="{{ url_for('controles.editar_control', id=control.id) }}" 
                                                   style="padding: 6px 10px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                                    ‚úèÔ∏è
                                                </a>

                                                {% if estado == 'Asignado' or estado == 'En Proceso' or estado == 'Planificado' %}
                                                    <form method="POST" action="{{ url_for('controles.marcar_implementado', id=control.id) }}" style="display: inline;">
                                                        <button type="submit" style="padding: 6px 10px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">
                                                            ‚úÖ
                                                        </button>
                                                    </form>
                                                {% elif estado == 'Implementado' %}
                                                    <button type="button" onclick="openVerifyModal({{ control.id }}, '{{ control.nombre }}')" 
                                                            style="padding: 6px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">
                                                        üìã
                                                    </button>
                                                {% elif estado == 'Requiere Ajuste' %}
                                                    <form method="POST" action="{{ url_for('controles.marcar_implementado', id=control.id) }}" style="display: inline;">
                                                        <button type="submit" style="padding: 6px 10px; background: #ffc107; color: #333; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">
                                                            üîÑ
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div style="background: white; padding: 60px; border-radius: 8px; border: 1px solid #ddd; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
            <h3 style="color: #666; margin: 0 0 10px 0;">No tienes controles asignados</h3>
            <p style="color: #999; margin: 0;">Solicita a un gestor que te asigne controles para comenzar</p>
        </div>
    {% endif %}
</div>

<!-- Modal Verificar -->
<div id="verifyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h3 id="modalTitle" style="margin-top: 0; color: #333;"></h3>
        <form id="verifyForm" method="POST" style="margin: 0;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                    Efectividad (%)
                </label>
                <input type="range" name="efectividad" id="effectivenessSlider" min="0" max="100" value="100"
                       style="width: 100%; height: 8px; cursor: pointer;" onchange="updateEffectivenessDisplay()">
                <div style="text-align: center; margin-top: 10px;">
                    <span id="effectivenessValue" style="font-size: 24px; font-weight: bold; color: #007bff;">100%</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                    Observaciones
                </label>
                <textarea name="observaciones" rows="3" 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; box-sizing: border-box; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                    ‚úÖ Verificar
                </button>
                <button type="button" onclick="closeVerifyModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                    ‚ùå Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentControlId = null;

    function openVerifyModal(controlId, controlName) {
        currentControlId = controlId;
        document.getElementById('modalTitle').textContent = 'üìã Verificar Control: ' + controlName;
        document.getElementById('verifyForm').action = '/controles/' + controlId + '/verificar';
        document.getElementById('verifyModal').style.display = 'flex';
    }

    function closeVerifyModal() {
        document.getElementById('verifyModal').style.display = 'none';
        currentControlId = null;
    }

    function updateEffectivenessDisplay() {
        const value = document.getElementById('effectivenessSlider').value;
        const displayElement = document.getElementById('effectivenessValue');
        displayElement.textContent = value + '%';
        
        // Cambiar color seg√∫n efectividad
        if (value >= 80) {
            displayElement.style.color = '#28a745';
        } else if (value >= 50) {
            displayElement.style.color = '#ffc107';
        } else {
            displayElement.style.color = '#dc3545';
        }
    }

    // Cerrar modal si se presiona Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeVerifyModal();
        }
    });

    // Cerrar modal si se hace click fuera
    document.getElementById('verifyModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeVerifyModal();
        }
    });
</script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
    }
    
    tr:hover {
        background: #f8f9fa !important;
    }
    
    button:hover, a:hover {
        opacity: 0.9;
    }
    
    input[type="range"]:hover {
        opacity: 0.8;
    }
</style>
{% endblock %}