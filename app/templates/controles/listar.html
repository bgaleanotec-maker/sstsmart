{% extends "base.html" %}

{% block title %}Controles - SST Colombia{% endblock %}

{% block content %}
<div style="padding: 30px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <div>
            <h1 style="margin: 0; color: #333; font-size: 28px;">
                üõ°Ô∏è Gesti√≥n de Controles
            </h1>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                Decreto 1072/2015 - Resoluci√≥n 0312/2019
            </p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('controles.crear_control') }}" style="padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                ‚ûï Nuevo Control
            </a>
            <a href="{{ url_for('controles.mis_controles') }}" style="padding: 10px 20px; background: #17a2b8; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                üë§ Mis Controles
            </a>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">TOTAL</div>
            <div style="font-size: 32px; font-weight: bold; color: #007bff;">{{ controles|length }}</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">EFECTIVOS</div>
            <div style="font-size: 32px; font-weight: bold; color: #28a745;">
                {% set efectivos = controles|selectattr('estado', 'equalto', 'Efectivo')|list|length %}
                {{ efectivos }}
            </div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">EN PROCESO</div>
            <div style="font-size: 32px; font-weight: bold; color: #ffc107;">
                {% set proceso = controles|selectattr('estado', 'equalto', 'En Proceso')|list|length %}
                {{ proceso }}
            </div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">EFECTIVIDAD PROMEDIO</div>
            <div style="font-size: 32px; font-weight: bold; color: #17a2b8;">
                {% set avg = (controles|map(attribute='efectividad_porcentaje')|list|sum / (controles|length or 1))|int %}
                {{ avg }}%
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #333;">üîç Filtros</h3>
        <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Estado</label>
                <select name="estado" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="">-- Todos --</option>
                    {% for estado in estados %}
                        <option value="{{ estado }}" {% if estado == filtro_estado %}selected{% endif %}>
                            {{ estado }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Riesgo</label>
                <select name="riesgo_id" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="">-- Todos --</option>
                    {% for riesgo in riesgos %}
                        <option value="{{ riesgo.id }}" {% if riesgo.id|string == filtro_riesgo %}selected{% endif %}>
                            {{ riesgo.nombre_riesgo }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <button type="submit" style="flex: 1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üîé Filtrar
                </button>
                <a href="{{ url_for('controles.listar_controles') }}" style="padding: 8px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üîÑ
                </a>
            </div>
        </form>
    </div>

    <!-- Tabla -->
    <div style="background: white; border-radius: 8px; border: 1px solid #ddd; overflow-x: auto;">
        <h3 style="padding: 20px 20px 0 20px; margin: 0; color: #333;">
            üìã Listado de Controles ({{ controles|length }} registros)
        </h3>

        {% if controles %}
            <table style="width: 100%; border-collapse: collapse; margin-top: 0;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">C√≥digo</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Nombre</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Tipo</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Riesgo</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Responsable</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Estado</th>
                        <th style="padding: 15px; text-align: left; font-weight: bold; color: #333; border-right: 1px solid #dee2e6;">Efectividad</th>
                        <th style="padding: 15px; text-align: center; font-weight: bold; color: #333;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for control in controles %}
                        <tr style="border-bottom: 1px solid #dee2e6; transition: background 0.2s;">
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                <span style="background: #e7f3ff; color: #0056b3; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px;">
                                    {{ control.codigo }}
                                </span>
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                <strong>{{ control.nombre }}</strong>
                                {% if control.descripcion %}
                                    <br><small style="color: #666;">{{ control.descripcion[:50] }}</small>
                                {% endif %}
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                {% set tipo_color = {
                                    'Preventivo': '#28a745',
                                    'Correctivo': '#ffc107',
                                    'Detectivo': '#17a2b8',
                                    'Mitigante': '#6c757d'
                                } %}
                                <span style="background: {{ tipo_color.get(control.tipo_control, '#6c757d') }}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                    {{ control.tipo_control }}
                                </span>
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                <small>
                                    {% if control.riesgo %}
                                        {{ control.riesgo.nombre_riesgo }}
                                    {% else %}
                                        <span style="color: #999;">Sin riesgo</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                <small>
                                    {% if control.responsable %}
                                        {{ control.responsable.nombre_completo }}
                                    {% else %}
                                        <span style="color: #999;">No asignado</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                {% set estado_color = {
                                    'Planificado': '#6c757d',
                                    'Asignado': '#17a2b8',
                                    'En Proceso': '#ffc107',
                                    'Implementado': '#007bff',
                                    'Verificado': '#28a745',
                                    'Efectivo': '#28a745',
                                    'Inefectivo': '#dc3545',
                                    'Requiere Ajuste': '#ffc107',
                                    'Cerrado': '#212529'
                                } %}
                                <span style="background: {{ estado_color.get(control.estado, '#6c757d') }}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                    {{ control.estado }}
                                </span>
                            </td>
                            <td style="padding: 15px; border-right: 1px solid #dee2e6;">
                                {% if control.efectividad_porcentaje %}
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 60px; height: 20px; background: #f0f0f0; border-radius: 3px; overflow: hidden; position: relative;">
                                            {% set color = '#28a745' if control.efectividad_porcentaje >= 80 else '#ffc107' if control.efectividad_porcentaje >= 50 else '#dc3545' %}
                                            <div style="width: {{ control.efectividad_porcentaje }}%; height: 100%; background: {{ color }}; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">
                                            </div>
                                        </div>
                                        <strong>{{ control.efectividad_porcentaje }}%</strong>
                                    </div>
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td style="padding: 15px; text-align: center;">
                                <div style="display: flex; gap: 5px; justify-content: center;">
                                    <a href="{{ url_for('controles.editar_control', id=control.id) }}" 
                                       style="padding: 5px 10px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                        ‚úèÔ∏è Editar
                                    </a>
                                    <button onclick="alert('Detalles de {{ control.nombre }}\n\nC√≥digo: {{ control.codigo }}\nTipo: {{ control.tipo_control }}\nNivel: {{ control.nivel_control }}\nResponsable: {{ control.responsable.nombre_completo if control.responsable else 'No asignado' }}\nEstado: {{ control.estado }}\nEfectividad: {{ control.efectividad_porcentaje or 'N/A' }}%')" 
                                            style="padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">
                                        üëÅÔ∏è Ver
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="padding: 40px; text-align: center; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                <h3>No hay controles registrados</h3>
                <p>Crea tu primer control para empezar</p>
                <a href="{{ url_for('controles.crear_control') }}" 
                   style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 10px;">
                    ‚ûï Crear Control
                </a>
            </div>
        {% endif %}
    </div>
</div>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
    }
    
    tr:hover {
        background: #f8f9fa !important;
    }
    
    button:hover {
        opacity: 0.9;
    }
    
    a:hover {
        opacity: 0.9;
    }
</style>
{% endblock %}