{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6">
    <div class="mb-6">
        <a href="{{ url_for('juridico.listar_consultas') }}" class="text-blue-600 hover:underline">
            &larr; Volver a consultas
        </a>
    </div>
    
    <!-- Encabezado de Consulta -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-bold">{{ consulta.titulo }}</h1>
                <p class="text-gray-600 font-mono text-lg">{{ consulta.numero_consulta }}</p>
            </div>
            <span class="px-4 py-2 rounded text-sm font-medium
                       {% if consulta.estado == 'Abierta' %}bg-blue-100 text-blue-800
                       {% elif consulta.estado == 'En revisi√≥n' %}bg-yellow-100 text-yellow-800
                       {% elif consulta.estado == 'En concepto' %}bg-purple-100 text-purple-800
                       {% elif consulta.estado == 'Resuelta' %}bg-green-100 text-green-800
                       {% else %}bg-gray-100 text-gray-800
                       {% endif %}">
                {{ consulta.estado }}
            </span>
        </div>
        
        <!-- Informaci√≥n General -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div>
                <p class="text-gray-600 text-sm font-semibold">Tipo de Consulta</p>
                <p class="text-lg">{{ consulta.tipo_consulta }}</p>
            </div>
            <div>
                <p class="text-gray-600 text-sm font-semibold">Prioridad</p>
                <p class="text-lg">{{ consulta.prioridad }}</p>
            </div>
            <div>
                <p class="text-gray-600 text-sm font-semibold">Riesgo Legal</p>
                <p class="text-lg">{{ consulta.riesgo_legal }}</p>
            </div>
            <div>
                <p class="text-gray-600 text-sm font-semibold">Confidencialidad</p>
                <p class="text-lg">{{ consulta.nivel_confidencialidad }}</p>
            </div>
            <div>
                <p class="text-gray-600 text-sm font-semibold">Fecha de Creaci√≥n</p>
                <p class="text-lg">{{ consulta.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            <div>
                <p class="text-gray-600 text-sm font-semibold">Horas Estimadas</p>
                <p class="text-lg">{{ consulta.horas_estimadas or 'Por definir' }}</p>
            </div>
        </div>
        
        <!-- Descripci√≥n -->
        <div class="mb-6">
            <p class="text-gray-600 text-sm font-semibold mb-2">Descripci√≥n</p>
            <p class="text-gray-800 bg-gray-50 p-4 rounded">{{ consulta.descripcion }}</p>
        </div>
        
        <!-- Asignar Abogado -->
        {% if current_user.rol in ['Admin', 'Responsable_SST'] and consulta.estado == 'Abierta' %}
        <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-6">
            <form method="POST" action="{{ url_for('juridico.asignar_abogado', consulta_id=consulta.id) }}" class="flex gap-4">
                <select name="abogado_id" required class="flex-1 px-4 py-2 border rounded">
                    <option value="">-- Selecciona abogado --</option>
                    {% for abogado in abogados %}
                    <option value="{{ abogado.id }}">
                        {{ abogado.usuario.nombre_completo }} - {{ abogado.especialidades }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Asignar
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    
    <!-- Tabs -->
    <div class="mb-6">
        <div class="border-b">
            <button onclick="showTab('concepto')" 
                    class="px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600">
                üí° Concepto Jur√≠dico
            </button>
            <button onclick="showTab('documentos')" 
                    class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-300">
                üìÑ Documentos ({{ documentos|length }})
            </button>
            <button onclick="showTab('comentarios')" 
                    class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-300">
                üí¨ Comentarios ({{ comentarios|length }})
            </button>
            <button onclick="showTab('auditoria')" 
                    class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-300">
                üîç Auditor√≠a
            </button>
        </div>
    </div>
    
    <!-- TAB: Concepto -->
    <div id="concepto" class="tab-content bg-white rounded-lg shadow p-6 mb-6">
        {% if consulta.concepto_legal %}
        <div class="bg-green-50 border border-green-200 rounded p-4 mb-6">
            <p class="text-gray-600 text-sm font-semibold mb-2">‚úì Concepto Emitido</p>
            <p class="text-gray-800">{{ consulta.concepto_legal }}</p>
        </div>
        
        {% if consulta.recomendaciones %}
        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-6">
            <p class="text-gray-600 text-sm font-semibold mb-2">üí° Recomendaciones</p>
            <p class="text-gray-800">{{ consulta.recomendaciones }}</p>
        </div>
        {% endif %}
        
        {% if consulta.normativa_aplicable %}
        <div class="bg-blue-50 border border-blue-200 rounded p-4">
            <p class="text-gray-600 text-sm font-semibold mb-2">üìã Normativa Aplicable</p>
            <ul class="text-gray-800">
                {% for norma in consulta.normativa_aplicable %}
                <li>‚Ä¢ {{ norma }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% else %}
        <p class="text-gray-500 text-center py-8">Pendiente de concepto jur√≠dico</p>
        {% endif %}
    </div>
    
    <!-- TAB: Documentos -->
    <div id="documentos" class="tab-content hidden bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">üìÑ Documentos de la Consulta</h3>
        
        {% if documentos %}
        <div class="space-y-3 mb-6">
            {% for doc in documentos %}
            <div class="flex justify-between items-center p-4 bg-gray-50 rounded border">
                <div>
                    <p class="font-semibold">{{ doc.nombre }}</p>
                    <p class="text-sm text-gray-600">v{{ doc.numero_version }} ‚Ä¢ {{ doc.tipo }} ‚Ä¢ {{ doc.clasificacion }}</p>
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('juridico.historial_documento', doc_id=doc.id) }}" 
                       class="text-blue-600 hover:underline text-sm">Versiones</a>
                    <a href="{{ url_for('juridico.descargar_documento', doc_id=doc.id) }}" 
                       class="text-blue-600 hover:underline text-sm">Descargar</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-center py-8">No hay documentos a√∫n</p>
        {% endif %}
        
        <!-- Agregar Documento -->
        {% if current_user.rol in ['Admin', 'Responsable_SST', 'Abogado'] %}
        <form method="POST" action="{{ url_for('juridico.agregar_documento', consulta_id=consulta.id) }}" 
              enctype="multipart/form-data" class="bg-blue-50 border border-blue-200 rounded p-4">
            <h4 class="font-semibold mb-4">+ Agregar Documento</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" name="nombre" placeholder="Nombre del documento" required
                       class="px-4 py-2 border rounded">
                <select name="tipo" required class="px-4 py-2 border rounded">
                    <option value="">-- Tipo --</option>
                    <option value="Contrato">Contrato</option>
                    <option value="Dictamen">Dictamen</option>
                    <option value="Concepto">Concepto</option>
                    <option value="Resoluci√≥n">Resoluci√≥n</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <select name="clasificacion" class="px-4 py-2 border rounded">
                    <option value="Interno">Interno</option>
                    <option value="Confidencial">Confidencial</option>
                    <option value="Restringido">Restringido</option>
                </select>
                <input type="file" name="archivo" class="px-4 py-2 border rounded">
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Agregar Documento
            </button>
        </form>
        {% endif %}
    </div>
    
    <!-- TAB: Comentarios -->
    <div id="comentarios" class="tab-content hidden bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">üí¨ Comentarios y Observaciones</h3>
        
        {% if comentarios %}
        <div class="space-y-4 mb-6">
            {% for comentario in comentarios %}
            <div class="p-4 bg-gray-50 rounded border-l-4 border-blue-600">
                <div class="flex justify-between items-start mb-2">
                    <p class="font-semibold">{{ comentario.usuario.nombre_completo }}</p>
                    <p class="text-sm text-gray-600">{{ comentario.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
                <p class="text-sm text-gray-700 mb-2">{{ comentario.contenido }}</p>
                <p class="text-xs text-gray-600">
                    <span class="px-2 py-1 rounded bg-gray-200">{{ comentario.tipo }}</span>
                    <span class="px-2 py-1 rounded ml-2">{{ comentario.prioridad }}</span>
                </p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Agregar Comentario -->
        <form method="POST" action="{{ url_for('juridico.agregar_comentario_consulta', consulta_id=consulta.id) }}"
              class="bg-blue-50 border border-blue-200 rounded p-4">
            <h4 class="font-semibold mb-4">+ Agregar Comentario</h4>
            <textarea name="contenido" placeholder="Escribe tu comentario..." required rows="3"
                      class="w-full px-4 py-2 border rounded mb-4"></textarea>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <select name="tipo" class="px-4 py-2 border rounded">
                    <option value="Observacion">Observaci√≥n</option>
                    <option value="Sugerencia">Sugerencia</option>
                    <option value="Acuerdo">Acuerdo</option>
                    <option value="Advertencia">Advertencia</option>
                </select>
                <select name="prioridad" class="px-4 py-2 border rounded">
                    <option value="Baja">Baja</option>
                    <option value="Normal" selected>Normal</option>
                    <option value="Alta">Alta</option>
                </select>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Publicar Comentario
            </button>
        </form>
    </div>
    
    <!-- TAB: Auditor√≠a -->
    <div id="auditoria" class="tab-content hidden bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-bold mb-4">üîç Historial de Auditor√≠a</h3>
        
        {% if auditoria %}
        <div class="space-y-3">
            {% for registro in auditoria %}
            <div class="p-3 bg-gray-50 rounded border-l-4 border-gray-400 text-sm">
                <div class="flex justify-between">
                    <span class="font-semibold">{{ registro.accion }}</span>
                    <span class="text-gray-600">{{ registro.fecha.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
                <p class="text-gray-700 mt-1">
                    <strong>Usuario:</strong> {{ registro.usuario.nombre_completo }}
                </p>
                {% if registro.razon %}
                <p class="text-gray-700 mt-1">
                    <strong>Raz√≥n:</strong> {{ registro.razon }}
                </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-center py-8">Sin registros de auditor√≠a</p>
        {% endif %}
    </div>
</div>

<script>
function showTab(tabName) {
    // Ocultar todos los tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.add('hidden'));
    
    // Mostrar el tab seleccionado
    document.getElementById(tabName).classList.remove('hidden');
    
    // Actualizar estilos de botones
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        if (btn.textContent.includes('üí°') || btn.textContent.includes('üìÑ') || 
            btn.textContent.includes('üí¨') || btn.textContent.includes('üîç')) {
            btn.classList.remove('border-blue-600', 'text-blue-600');
            btn.classList.add('border-transparent');
        }
    });
    
    // Resaltar bot√≥n activo
    event.target.classList.add('border-blue-600', 'text-blue-600');
    event.target.classList.remove('border-transparent');
}
</script>
{% endblock %}