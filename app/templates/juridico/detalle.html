{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ consulta.numero_consulta }}</h1>
            <p class="text-gray-600">{{ consulta.titulo }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('juridico.listar') }}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                ‚Üê Volver
            </a>
            <a href="{{ url_for('juridico.descargar_reporte', id=consulta.id) }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                üìÑ Descargar PDF
            </a>
        </div>
    </div>

    <!-- Estado y Badges -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-wrap gap-3 mb-4">
            <span class="px-3 py-1 rounded-full text-sm font-semibold
                {% if consulta.estado == 'Abierta' %}bg-yellow-100 text-yellow-800
                {% elif consulta.estado == 'En revisi√≥n' %}bg-blue-100 text-blue-800
                {% elif consulta.estado == 'Resuelta' %}bg-green-100 text-green-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ consulta.estado }}
            </span>
            <span class="px-3 py-1 rounded-full text-sm font-semibold
                {% if consulta.prioridad == 'Cr√≠tica' %}bg-red-100 text-red-800
                {% elif consulta.prioridad == 'Alta' %}bg-orange-100 text-orange-800
                {% elif consulta.prioridad == 'Normal' %}bg-blue-100 text-blue-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                Prioridad: {{ consulta.prioridad }}
            </span>
            <span class="px-3 py-1 rounded-full text-sm font-semibold
                {% if consulta.riesgo_legal == 'Cr√≠tico' %}bg-red-100 text-red-800
                {% elif consulta.riesgo_legal == 'Alto' %}bg-orange-100 text-orange-800
                {% elif consulta.riesgo_legal == 'Medio' %}bg-yellow-100 text-yellow-800
                {% else %}bg-green-100 text-green-800{% endif %}">
                Riesgo: {{ consulta.riesgo_legal }}
            </span>
        </div>

        {% if sla_excedido %}
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
            <p class="text-red-700 font-semibold">‚ö†Ô∏è SLA Excedido - {{ sla_dias }} d√≠as transcurridos</p>
        </div>
        {% endif %}

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <p class="text-sm text-gray-600">Tipo</p>
                <p class="font-semibold">{{ consulta.tipo_consulta }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Creado por</p>
                <p class="font-semibold">{{ consulta.responsable_creador.nombre_completo if consulta.responsable_creador else 'N/A' }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Fecha creaci√≥n</p>
                <p class="font-semibold">{{ consulta.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Abogado asignado</p>
                <p class="font-semibold">{{ consulta.abogado.nombre_completo if consulta.abogado else 'Sin asignar' }}</p>
            </div>
        </div>
    </div>

    <!-- Asignar Abogado -->
    {% if puede_asignar and consulta.estado == 'Abierta' %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">‚öñÔ∏è Asignar Abogado</h2>
        <form method="POST" action="{{ url_for('juridico.detalle', id=consulta.id) }}" class="flex gap-4">
            <input type="hidden" name="accion" value="asignar">
            <select name="abogado_id" required class="flex-1 px-4 py-2 border rounded">
                <option value="">Seleccionar abogado...</option>
                {% for abogado in abogados %}
                <option value="{{ abogado.id }}">{{ abogado.nombre_completo }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                Asignar
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Descripci√≥n -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">üìù Descripci√≥n</h2>
        <p class="text-gray-700 whitespace-pre-wrap">{{ consulta.descripcion }}</p>
    </div>

    <!-- Resolver Consulta -->
    {% if puede_resolver and consulta.estado in ['Abierta', 'En revisi√≥n'] %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">‚úÖ Resolver Consulta</h2>
        <form method="POST" action="{{ url_for('juridico.detalle', id=consulta.id) }}">
            <input type="hidden" name="accion" value="resolver">
            
            <div class="mb-4">
                <label class="block font-semibold mb-2">Resoluci√≥n *</label>
                <textarea name="resolucion" required rows="6" 
                    class="w-full px-4 py-2 border rounded"
                    placeholder="Describa la resoluci√≥n legal de la consulta..."></textarea>
            </div>

            <div class="mb-4">
                <label class="block font-semibold mb-2">Recomendaciones</label>
                <textarea name="recomendaciones" rows="4" 
                    class="w-full px-4 py-2 border rounded"
                    placeholder="Recomendaciones adicionales..."></textarea>
            </div>

            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                ‚úÖ Marcar como Resuelta
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Resoluci√≥n (si ya est√° resuelta) -->
    {% if consulta.resolucion %}
    <div class="bg-green-50 rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4 text-green-800">‚úÖ Resoluci√≥n</h2>
        <div class="mb-4">
            <p class="text-sm text-gray-600 mb-1">Resuelta por: {{ consulta.abogado.nombre_completo if consulta.abogado else 'N/A' }}</p>
            <p class="text-sm text-gray-600">Fecha: {{ consulta.fecha_resolucion.strftime('%d/%m/%Y %H:%M') if consulta.fecha_resolucion else 'N/A' }}</p>
        </div>
        <div class="bg-white p-4 rounded border border-green-200">
            <p class="text-gray-700 whitespace-pre-wrap">{{ consulta.resolucion }}</p>
        </div>

        {% if consulta.recomendaciones %}
        <div class="mt-4">
            <h3 class="font-bold mb-2">üí° Recomendaciones</h3>
            <div class="bg-white p-4 rounded border border-green-200">
                <p class="text-gray-700 whitespace-pre-wrap">{{ consulta.recomendaciones }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Documentos Legales -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">üìë Documentos Legales</h2>
        
        {% if documentos %}
        <div class="space-y-2 mb-4">
            {% for doc in documentos %}
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded border">
                <div>
                    <p class="font-semibold">{{ doc.nombre }}</p>
                    <p class="text-sm text-gray-600">Tipo: {{ doc.tipo }} | Creado: {{ doc.fecha_creacion.strftime('%d/%m/%Y') }}</p>
                </div>
                <form method="POST" action="{{ url_for('juridico.eliminar_documento', doc_id=doc.id) }}" class="inline">
                    <button type="submit" onclick="return confirm('¬øEliminar documento?')" 
                        class="text-red-600 hover:text-red-800">
                        üóëÔ∏è Eliminar
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 mb-4">No hay documentos cargados</p>
        {% endif %}

        <!-- Cargar nuevo documento -->
        <details class="border-t pt-4">
            <summary class="cursor-pointer font-semibold text-blue-600 hover:text-blue-800">
                ‚ûï Cargar Nuevo Documento
            </summary>
            <form method="POST" action="{{ url_for('juridico.cargar_documento', id=consulta.id) }}" class="mt-4 space-y-3">
                <div>
                    <label class="block font-semibold mb-2">Nombre del documento *</label>
                    <input type="text" name="nombre" required class="w-full px-4 py-2 border rounded">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Tipo *</label>
                    <select name="tipo" required class="w-full px-4 py-2 border rounded">
                        <option value="">Seleccionar tipo...</option>
                        <option value="Concepto Jur√≠dico">Concepto Jur√≠dico</option>
                        <option value="Dictamen">Dictamen</option>
                        <option value="Constancia">Constancia</option>
                        <option value="Acta">Acta</option>
                        <option value="Sentencia">Sentencia</option>
                        <option value="Resoluci√≥n">Resoluci√≥n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Contenido</label>
                    <textarea name="contenido" rows="4" class="w-full px-4 py-2 border rounded"></textarea>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    Cargar Documento
                </button>
            </form>
        </details>
    </div>

    <!-- Acciones de Estado -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">üîß Acciones</h2>
        <div class="flex gap-3 flex-wrap">
            {% if puede_cerrar and consulta.estado == 'Resuelta' %}
            <form method="POST" action="{{ url_for('juridico.detalle', id=consulta.id) }}" class="inline">
                <input type="hidden" name="accion" value="cerrar">
                <button type="submit" onclick="return confirm('¬øCerrar consulta?')"
                    class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    üîí Cerrar Consulta
                </button>
            </form>
            {% endif %}

            {% if puede_cerrar and consulta.estado == 'Cerrada' %}
            <form method="POST" action="{{ url_for('juridico.detalle', id=consulta.id) }}" class="inline">
                <input type="hidden" name="accion" value="reabrir">
                <button type="submit" onclick="return confirm('¬øReabrir consulta?')"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    üîì Reabrir Consulta
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}